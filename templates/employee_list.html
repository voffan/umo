{% extends 'base.html' %}
{% block title %}Штатное расписание{% endblock %}
{% block content %}
{% csrf_token %}
<style>
    .wtHider{
        width:150px !important;
    }
    .handsontableInputHolder .wtSpreader .htCore{
        width:150px !important;
    }
</style>
<nav style="margin: 0px 0px 20px 0px;" class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container-fluid">
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="{% url 'hours:course_list' %}">Список курсов</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'hours:contingent_list' %}">Список контингента</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'hours:employee_list' %}">Штатное расписание</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<h1>Штатное расписание</h1>
<p align="right" id="employee_list_filter">
    <label>
        <b>Type</b>
    </label>
    <br>
</p>
<div id="employeelist"></div>
<a href="{% url 'hours:create_employee' %}" class="btn btn-success">Добавить сотрудника</a>
<button id="save" class="btn btn-success" name="save">Сохранить изменения</button>
<a href="{{ updatedExportLink }}" id="export-kup" class="btn btn-danger" name="export">Экспорт КУП</a>


{% endblock %}

{% block scripts %}
var hot;
let checkedTeachersIds = [];
let columns = [
  	{
    	data: 'id',
    	title: 'Id',
    },
    {
    	data: 'teacher',
    	title: 'Преподаватель',
        renderer: 'html',
<!--        source: [{% for item in teacher %}{_id:"{{ item.id }}", label: "{{ item.FIO }}"},{% endfor %}],-->
    },
    {
    	data: 'stavka',
    	title: 'Ставка',
        type: 'numeric',
    },
    {
    	data: 'employee_type',
    	title: 'Тип',
        type: 'key-value-list',
        source: [{% for item in employee_type %}{_id:"{{ item.0 }}", label: "{{ item.1 }}"},{% endfor %}]
    },

    {
    	data: 'is_active',
    	title: 'Преподаватель активен',
    	type: 'checkbox',
    },
    {
        data: 'position',
        title: 'Должность',
    },
    {
        data: 'title',
        title: 'Ученое звание',
    },
    {
        data: 'teacher_id',
        title: 'ID преподавателя'
    },
    {
        data: 'kup',
        title: 'Экпорт КУП',
        type: 'checkbox',
    }
];

fetch("{% url 'hours:api:get_employeelist' %}")
.then((response)=>{
    if(response.status != 200)
    {
        //process error
        return [];
    }
    return response.json();
})
.then((data)=>{
    const container = document.getElementById('employeelist');
    hot = new Handsontable(container, {
      data: data,
      rowHeaders: true,
      colHeaders: true,
      height: 300,
      hiddenColumns: {
        columns: [0, 7]
      },
      language: 'ru-RU',
      licenseKey: 'non-commercial-and-evaluation',
      columns: columns,
      beforeValidate:(value, row, prop)=>{
        if(prop === 'teacher') {
            columns[1].source.forEach((el, index) => {
                if(el.label.includes(value)) {
                    //console.log(el);
                    console.log(value);
                    return (value = el._id);
                }
            });
        }
        return value;
      },
      afterChange: (changes, source) => {
        if(source === 'loadData') {
          return;
        }

        changes.forEach(([row,prop,oldValue,newValue]) => {
          if(prop === 'kup') {
            let teacherId = hot.getDataAtRowProp(row,'teacher_id');
            if (newValue) {
              if (!checkedTeachersIds.includes(teacherId)) {
                checkedTeachersIds.push(teacherId);
              }
            } else {
              checkedTeachersIds = checkedTeachersIds.filter(id => id !== teacherId);
            }
            updateLinkWithIds();
            console.log(checkedTeachersIds)
          }
        });
      }
    });
    //console.log(data);
    //console.log(hot.getSourceData());
});

function updateLinkWithIds() {
    let link = "{% url 'hours:employee_list' %}";
    let exportLink = "{% url 'hours:export_kup' %}";
    let idsString = checkedTeachersIds.join('&ids=');
    let updatedLink = `${exportLink}?ids=${idsString}`;
    let updatedExportLink = `${exportLink}?ids=${idsString}`;
    console.log('Updated link:', updatedLink);
    history.pushState(null, null, updatedLink);
    console.log(updatedExportLink);
}

let saveButton  = document.querySelector('#save');
saveButton.addEventListener('click', () => {
    fetch("{% url 'hours:api:save_employeelist' %}", {
        method: 'POST',
        body: JSON.stringify({'data': hot.getData()}),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
    })
    .then((response) => response.json())
    .then((data) => {
        console.log('Success:', hot.getData());
    })
    .catch((error) => {
        console.error('Error:', error);
<!--        undoRedo.undo()-->
        alert("Ошибка в сохранении");
    })
});
{% endblock %}